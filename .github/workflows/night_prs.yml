name: Auto PR from feature branches to dev

on:
  workflow_dispatch:  # permette di far partire manualmente
  schedule:
    - cron: '0 0 * * 3'  # Tra marted√¨ e mercoled√¨ a mezzanotte

jobs:
  create-prs:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # serve per avere tutti i branch remoti e la storia completa

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Generate PRs from feature branches
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        DATE=$(date +'%Y-%m-%d')
        FOUND=false
        ...


        # Ciclo su tutti i branch remoti tranne dev e main
        for branch in $(git branch -r | grep origin/ | sed 's|origin/||'); do
          if [[ "$branch" == "dev" || "$branch" == "main" ]]; then
            continue
          fi

          # Prendi i commit non ancora in dev
          COMMITS=$(git log dev..origin/$branch --pretty=format="- %s (%an)")

          # Se non ci sono commit nuovi, salta il branch
          if [ -z "$COMMITS" ]; then
            continue
          fi

          FOUND=true

          # Creo il file per il body della PR
          echo "ü§ñ **Pull Request generata automaticamente**" > pr_body.md
          echo "" >> pr_body.md
          echo "Questa PR √® stata creata da una GitHub Action schedulata." >> pr_body.md
          echo "" >> pr_body.md
          echo "### üîÄ Branch" >> pr_body.md
          echo "\`$branch\`" >> pr_body.md
          echo "" >> pr_body.md
          echo "### üéØ Integrazione" >> pr_body.md
          echo "\`dev <- $branch\`" >> pr_body.md
          echo "" >> pr_body.md
          echo "### üì¶ Modifiche incluse" >> pr_body.md
          echo "$COMMITS" >> pr_body.md
          echo "" >> pr_body.md
          echo "‚ö†Ô∏è **PR automatica**" >> pr_body.md
          echo "Non √® stata aperta manualmente dal team." >> pr_body.md

          # Creo la PR, ignoro se gi√† esistente
          gh pr create \
            --head "$branch" \
            --base dev \
            --title "[PR AUTO] dev <- $branch | $DATE" \
            --body-file pr_body.md \
            --label "auto-pr" \
            || echo "PR gi√† esistente per $branch"

          # Auto-merge se possibile, ignoro errori
          gh pr merge "$branch" \
            --auto \
            --merge \
            || true
        done

        if [ "$FOUND" = false ]; then
          echo "No branches with new commits to create PRs for"
        fi
