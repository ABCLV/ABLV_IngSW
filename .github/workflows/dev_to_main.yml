name: Weekly Dev to Main PR

on:
  schedule:
    - cron: '15 12 * * *' # Mercoled√¨ 00:35 (diverso per testing)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dev-main-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch dev branch
        run: git fetch origin dev

      - name: Check recent activity on dev
        id: activity
        run: |
          LAST_COMMIT_TS=$(git log origin/dev -1 --format=%ct)
          NOW_TS=$(date +%s)
          DIFF_DAYS=$(( (NOW_TS - LAST_COMMIT_TS) / 86400 ))

          echo "Days since last dev commit: $DIFF_DAYS"

          if [ "$DIFF_DAYS" -le 7 ]; then
            echo "active=true" >> $GITHUB_OUTPUT
          else
            echo "active=false" >> $GITHUB_OUTPUT
          fi

      - name: Create dev to main PR
        if: steps.activity.outputs.active == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat <<EOF > pr_body.md
ü§ñ **Pull Request di rilascio automatica**

Il branch \`dev\` ha ricevuto modifiche nell‚Äôultima settimana.
Questa PR avvia il merge settimanale verso \`main\`.

---

‚ö†Ô∏è **PR automatica**
Non √® stata aperta manualmente dal team.
EOF

          gh pr create \
            --head dev \
            --base main \
            --title "[PR AUTO] main <- dev | weekly release" \
            --body-file pr_body.md \
            --label "release" \
            || echo "PR dev -> main gi√† esistente"

          gh pr merge dev \
            --auto \
            --merge \
            || true

      - name: No changes on dev
        if: steps.activity.outputs.active == 'false'
        run: |
          echo "No changes on dev in the last week"
