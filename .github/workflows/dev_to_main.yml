name: Weekly Dev to Main PR

on:
  schedule:
    - cron: '31 12 * * 3' # Mercoled√¨ 01:00 (diverso per testing)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  dev-main-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch dev branch
        run: git fetch origin dev

      - name: Check recent activity on dev
        id: activity
        run: |
          LAST_COMMIT_TS=$(git log origin/dev -1 --format=%ct)
          NOW_TS=$(date +%s)
          DIFF_DAYS=$(( (NOW_TS - LAST_COMMIT_TS) / 86400 ))
          echo "Days since last dev commit: $DIFF_DAYS"

          if [ "$DIFF_DAYS" -le 7 ]; then
            echo "active=true" >> $GITHUB_OUTPUT
          else
            echo "active=false" >> $GITHUB_OUTPUT
          fi

      - name: Create dev to main PR
        if: steps.activity.outputs.active == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ü§ñ **Pull Request di rilascio automatica**" > pr_body.md
          echo "" >> pr_body.md
          echo "Il branch \`dev\` ha ricevuto modifiche nell‚Äôultima settimana." >> pr_body.md
          echo "Questa PR avvia il merge settimanale verso \`main\`." >> pr_body.md
          echo "" >> pr_body.md
          echo "‚ö†Ô∏è **PR automatica**" >> pr_body.md
          echo "Non √® stata aperta manualmente dal team." >> pr_body.md

          gh pr create \
            --head dev \
            --base main \
            --title "[PR AUTO] main <- dev | weekly release" \
            --body-file pr_body.md \
            --label "release" \
            || echo "PR dev -> main gi√† esistente"

          gh pr merge dev \
            --auto \
            --merge \
            || true

      - name: No changes on dev
        if: steps.activity.outputs.active == 'false'
        run: echo "No changes on dev in the last week"
